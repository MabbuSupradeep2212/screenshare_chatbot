<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Share Assistant</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>Screen Share Assistant</h1>
            <p>Share your screen and get intelligent analysis of the content</p>
        </header>

        <main class="main-content">
            <section class="screen-section">
                <div class="status-bar">
                    <div id="statusIndicator" class="status-indicator"></div>
                    <span id="connectionStatus">Not connected</span>
                </div>
                
                <div class="screen-container">
                    <video id="screenShare" autoplay></video>
                </div>
                
                <div class="controls">
                    <button id="startShare" class="tooltip">
                        <span class="tooltip-text">Start sharing your screen</span>
                        Start Screen Share
                    </button>
                    <button id="stopShare" class="stop" disabled>Stop Share</button>
                </div>
            </section>

            <section class="chat-section">
                <h2>AI Assistant</h2>
                <div class="chat-container">
                    <div id="chatMessages" class="chat-messages"></div>
                    <div class="input-container">
                        <input type="text" 
                               id="userInput" 
                               placeholder="Ask about the screen content..."
                               aria-label="Your message">
                        <button id="sendQuery">
                            Send
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Socket.IO configuration
        const socket = io({
            transports: ['websocket'],
            upgrade: false
        });

        // DOM elements
        const screenShare = document.getElementById('screenShare');
        const startShareBtn = document.getElementById('startShare');
        const stopShareBtn = document.getElementById('stopShare');
        const userInput = document.getElementById('userInput');
        const sendQueryBtn = document.getElementById('sendQuery');
        const chatMessages = document.getElementById('chatMessages');
        const connectionStatus = document.getElementById('connectionStatus');
        const statusIndicator = document.getElementById('statusIndicator');

        // Generate room ID
        const roomId = 'room_' + Math.random().toString(36).substr(2, 9);

        // Socket.IO event handlers
        socket.on('connect', () => {
            connectionStatus.textContent = 'Connected';
            statusIndicator.classList.add('connected');
            socket.emit('join', { room: roomId });
        });

        socket.on('disconnect', () => {
            connectionStatus.textContent = 'Disconnected';
            statusIndicator.classList.remove('connected');
        });

        socket.on('response', (data) => {
            if (data.error) {
                addMessage(data.error, 'error');
            } else {
                addMessage(data.response, 'assistant');
            }
        });

        // Screen sharing functionality
        async function checkScreenSharingSupport() {
            if (!window.isSecureContext) {
                addMessage('Screen sharing requires HTTPS or localhost. Please use a secure connection.', 'error');
                startShareBtn.disabled = true;
                return false;
            }

            if (!navigator?.mediaDevices?.getDisplayMedia) {
                addMessage('Screen sharing is not supported in this browser. Please use Chrome, Firefox, or Edge.', 'error');
                startShareBtn.disabled = true;
                return false;
            }

            return true;
        }

        // Start screen sharing
        startShareBtn.addEventListener('click', async () => {
            if (!await checkScreenSharingSupport()) return;
            
            try {
                stream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: "always"
                    },
                    audio: false
                });
                
                screenShare.srcObject = stream;
                startShareBtn.disabled = true;
                stopShareBtn.disabled = false;

                // Start sending frames
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                const videoTrack = stream.getVideoTracks()[0];

                // Send frames every 500ms
                const frameInterval = setInterval(() => {
                    if (!stream) {
                        clearInterval(frameInterval);
                        return;
                    }

                    canvas.width = screenShare.videoWidth;
                    canvas.height = screenShare.videoHeight;
                    context.drawImage(screenShare, 0, 0, canvas.width, canvas.height);
                    
                    const frame = canvas.toDataURL('image/jpeg', 0.5);
                    socket.emit('stream-frame', {
                        frame: frame,
                        room: roomId
                    });
                }, 500);

                // Handle stream end
                videoTrack.onended = () => {
                    stopSharing();
                    clearInterval(frameInterval);
                };
            } catch (err) {
                console.error('Error starting screen share:', err);
                addMessage('Error starting screen share: ' + err.message, 'error');
            }
        });

        // Stop screen sharing
        stopShareBtn.addEventListener('click', stopSharing);

        function stopSharing() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                screenShare.srcObject = null;
                startShareBtn.disabled = false;
                stopShareBtn.disabled = true;
            }
        }

        // Chat functionality
        sendQueryBtn.addEventListener('click', sendQuery);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendQuery();
            }
        });

        function sendQuery() {
            const query = userInput.value.trim();
            if (query) {
                socket.emit('query', {
                    query: query,
                    room: roomId
                });
                addMessage(query, 'user');
                userInput.value = '';
            }
        }

        function addMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.textContent = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Initial support check
        checkScreenSharingSupport();
    </script>
</body>
</html>